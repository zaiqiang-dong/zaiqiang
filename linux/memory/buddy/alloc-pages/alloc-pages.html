<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>页面分配基本流程 | 探索者</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/hero.png">
    <meta name="description" content="-> 在 LINUX ANDROID 中不断探索 <-">
    
    <link rel="preload" href="/assets/css/0.styles.a5340219.css" as="style"><link rel="preload" href="/assets/js/app.da3d5808.js" as="script"><link rel="preload" href="/assets/js/2.5ade7cf8.js" as="script"><link rel="preload" href="/assets/js/41.327a65a5.js" as="script"><link rel="prefetch" href="/assets/js/10.3d5ca2a6.js"><link rel="prefetch" href="/assets/js/100.76b2b440.js"><link rel="prefetch" href="/assets/js/101.68818f09.js"><link rel="prefetch" href="/assets/js/102.bd5a407b.js"><link rel="prefetch" href="/assets/js/11.3cb3822c.js"><link rel="prefetch" href="/assets/js/12.c8592c81.js"><link rel="prefetch" href="/assets/js/13.e44c1289.js"><link rel="prefetch" href="/assets/js/14.7f10829c.js"><link rel="prefetch" href="/assets/js/15.b5505134.js"><link rel="prefetch" href="/assets/js/16.3164635b.js"><link rel="prefetch" href="/assets/js/17.48283d6e.js"><link rel="prefetch" href="/assets/js/18.6672bcfb.js"><link rel="prefetch" href="/assets/js/19.47ec2f35.js"><link rel="prefetch" href="/assets/js/20.76b9d5bb.js"><link rel="prefetch" href="/assets/js/21.3d2cc873.js"><link rel="prefetch" href="/assets/js/22.829afe10.js"><link rel="prefetch" href="/assets/js/23.d765329a.js"><link rel="prefetch" href="/assets/js/24.de71792e.js"><link rel="prefetch" href="/assets/js/25.02803fe6.js"><link rel="prefetch" href="/assets/js/26.51eba5f9.js"><link rel="prefetch" href="/assets/js/27.32a33044.js"><link rel="prefetch" href="/assets/js/28.5b2d68fc.js"><link rel="prefetch" href="/assets/js/29.0ff9e48c.js"><link rel="prefetch" href="/assets/js/3.52df1271.js"><link rel="prefetch" href="/assets/js/30.389490cd.js"><link rel="prefetch" href="/assets/js/31.5481ef3f.js"><link rel="prefetch" href="/assets/js/32.661cc48e.js"><link rel="prefetch" href="/assets/js/33.faa8da2a.js"><link rel="prefetch" href="/assets/js/34.86c4c7c6.js"><link rel="prefetch" href="/assets/js/35.cc59f876.js"><link rel="prefetch" href="/assets/js/36.225aeb83.js"><link rel="prefetch" href="/assets/js/37.2cc14515.js"><link rel="prefetch" href="/assets/js/38.14b0befb.js"><link rel="prefetch" href="/assets/js/39.c7d84e1c.js"><link rel="prefetch" href="/assets/js/4.92007084.js"><link rel="prefetch" href="/assets/js/40.ca8604e5.js"><link rel="prefetch" href="/assets/js/42.e66817c0.js"><link rel="prefetch" href="/assets/js/43.27c5f648.js"><link rel="prefetch" href="/assets/js/44.6bb4eee8.js"><link rel="prefetch" href="/assets/js/45.61f5cad3.js"><link rel="prefetch" href="/assets/js/46.1ecfa3a5.js"><link rel="prefetch" href="/assets/js/47.e7858372.js"><link rel="prefetch" href="/assets/js/48.27da066f.js"><link rel="prefetch" href="/assets/js/49.612aeef0.js"><link rel="prefetch" href="/assets/js/5.75e6af80.js"><link rel="prefetch" href="/assets/js/50.63888e47.js"><link rel="prefetch" href="/assets/js/51.b265e9b4.js"><link rel="prefetch" href="/assets/js/52.a598859d.js"><link rel="prefetch" href="/assets/js/53.359610ab.js"><link rel="prefetch" href="/assets/js/54.955b5f47.js"><link rel="prefetch" href="/assets/js/55.9ce4e316.js"><link rel="prefetch" href="/assets/js/56.ccbbfd33.js"><link rel="prefetch" href="/assets/js/57.bf4dbcdc.js"><link rel="prefetch" href="/assets/js/58.3a8cd82f.js"><link rel="prefetch" href="/assets/js/59.14430dbc.js"><link rel="prefetch" href="/assets/js/6.8aeba432.js"><link rel="prefetch" href="/assets/js/60.837d9d15.js"><link rel="prefetch" href="/assets/js/61.4ada8200.js"><link rel="prefetch" href="/assets/js/62.2099847a.js"><link rel="prefetch" href="/assets/js/63.28c71ad4.js"><link rel="prefetch" href="/assets/js/64.74100073.js"><link rel="prefetch" href="/assets/js/65.d36d3db9.js"><link rel="prefetch" href="/assets/js/66.c0b5299d.js"><link rel="prefetch" href="/assets/js/67.8672d344.js"><link rel="prefetch" href="/assets/js/68.9487e4bd.js"><link rel="prefetch" href="/assets/js/69.0fa35dd0.js"><link rel="prefetch" href="/assets/js/7.b163982a.js"><link rel="prefetch" href="/assets/js/70.a43945a7.js"><link rel="prefetch" href="/assets/js/71.d9000c52.js"><link rel="prefetch" href="/assets/js/72.38a3fae1.js"><link rel="prefetch" href="/assets/js/73.fd34fff5.js"><link rel="prefetch" href="/assets/js/74.96a689fe.js"><link rel="prefetch" href="/assets/js/75.d47cae83.js"><link rel="prefetch" href="/assets/js/76.77fbed6a.js"><link rel="prefetch" href="/assets/js/77.b32a6899.js"><link rel="prefetch" href="/assets/js/78.311ec8e9.js"><link rel="prefetch" href="/assets/js/79.2c16f99d.js"><link rel="prefetch" href="/assets/js/8.c9e82286.js"><link rel="prefetch" href="/assets/js/80.76a3428e.js"><link rel="prefetch" href="/assets/js/81.9853ddd1.js"><link rel="prefetch" href="/assets/js/82.3345c243.js"><link rel="prefetch" href="/assets/js/83.ecfb65bf.js"><link rel="prefetch" href="/assets/js/84.20c34bf4.js"><link rel="prefetch" href="/assets/js/85.d4408fdc.js"><link rel="prefetch" href="/assets/js/86.3d868090.js"><link rel="prefetch" href="/assets/js/87.976c5956.js"><link rel="prefetch" href="/assets/js/88.0e30edb9.js"><link rel="prefetch" href="/assets/js/89.a5fe917d.js"><link rel="prefetch" href="/assets/js/9.ef4edfb9.js"><link rel="prefetch" href="/assets/js/90.436a473d.js"><link rel="prefetch" href="/assets/js/91.19f664fd.js"><link rel="prefetch" href="/assets/js/92.ac8ead98.js"><link rel="prefetch" href="/assets/js/93.ebf93eba.js"><link rel="prefetch" href="/assets/js/94.7aa71382.js"><link rel="prefetch" href="/assets/js/95.fc6e4910.js"><link rel="prefetch" href="/assets/js/96.64783ff4.js"><link rel="prefetch" href="/assets/js/97.900052f3.js"><link rel="prefetch" href="/assets/js/98.819f6c69.js"><link rel="prefetch" href="/assets/js/99.6f437338.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a5340219.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">探索者</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/" class="nav-link router-link-active">
  内核
</a></div><div class="nav-item"><a href="/hardware/" class="nav-link">
  硬件
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/coding/" class="nav-link">
  编码
</a></div><div class="nav-item"><a href="/optimization/" class="nav-link">
  调优
</a></div><div class="nav-item"><a href="/virtualization/" class="nav-link">
  虚拟化
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/" class="nav-link router-link-active">
  内核
</a></div><div class="nav-item"><a href="/hardware/" class="nav-link">
  硬件
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/coding/" class="nav-link">
  编码
</a></div><div class="nav-item"><a href="/optimization/" class="nav-link">
  调优
</a></div><div class="nav-item"><a href="/virtualization/" class="nav-link">
  虚拟化
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>内存管理</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>common</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>buddy</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/linux/memory/buddy/alloc-flags/alloc-flags.html" class="sidebar-link">页分配掩码</a></li><li><a href="/linux/memory/buddy/wartermark/watermark.html" class="sidebar-link">水位线的计算</a></li><li><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html" aria-current="page" class="active sidebar-link">页面分配基本流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_1-接口函数" class="sidebar-link">1. 接口函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_1-1-alloc-page" class="sidebar-link">1.1 alloc_page</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_1-2-get-free-pages" class="sidebar-link">1.2 _getfree_pages</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_1-3-get-free-page" class="sidebar-link">1.3 _getfree_page</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_1-4-get-zeroed-page" class="sidebar-link">1.4 getzeroedpage</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_1-5-get-dma-pages" class="sidebar-link">1.5 _getdma_pages</a></li></ul></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_2-alloc-pages" class="sidebar-link">2. alloc_pages</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_2-1-alloc-pages-node" class="sidebar-link">2.1 allocpagesnode</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_2-2-alloc-pages-node" class="sidebar-link">2.2 _allocpages_node</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_2-3-alloc-pages" class="sidebar-link">2.3 _allocpages</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_3-alloc-pages-nodemask" class="sidebar-link">3. _allocpages_nodemask</a></li></ul></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/alloc-pages/alloc-pages.html#_4-小结" class="sidebar-link">4. 小结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>slxb</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发同步</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进程管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中断系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全机制</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统机制</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统信号</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>电源管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>时间系统</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="页面分配基本流程"><a href="#页面分配基本流程" class="header-anchor">#</a> 页面分配基本流程</h1> <hr> <table><thead><tr><th>软件版本</th> <th>硬件版本</th> <th>更新内容</th></tr></thead> <tbody><tr><td>linux 5.8.18</td> <td>arm64</td> <td></td></tr></tbody></table> <hr> <p>本章只是梳理页面分配流程，不存在代码思想的解析。</p> <h2 id="_1-接口函数"><a href="#_1-接口函数" class="header-anchor">#</a> 1. 接口函数</h2> <h3 id="_1-1-alloc-page"><a href="#_1-1-alloc-page" class="header-anchor">#</a> 1.1 alloc_page</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define alloc_page(gfp_mask) alloc_pages(gfp_mask, 0)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>从代码可以看出<code>alloc_page</code>最终调用的是<code>alloc_pages</code>,只是在第二个参数的位置写0,表示 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="2.044ex" height="1.887ex" viewBox="0 -833.9 903.6 833.9" style="vertical-align:0;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mn" transform="translate(500, 363) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></g></svg></mjx-container>,也就是1个页面。</p> <h3 id="_1-2-get-free-pages"><a href="#_1-2-get-free-pages" class="header-anchor">#</a> 1.2 __get_free_pages</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>unsigned long __get_free_pages(gfp_t gfp_mask, unsigned int order)
{
	struct page *page;

	page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order);
	if (!page)
		return 0;
	return (unsigned long) page_address(page);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>同样的<code>__get_free_pages</code>也是调用了调用了<code>alloc_pages</code>,只是在<code>gfp_mask</code>参数部分清除了<code>__GFP_HIGHMEM</code>,也就是不能从高端内存部分分配。这里最后一行<code>page_address</code>,表示返回的是页面的虚拟地址。</p> <h3 id="_1-3-get-free-page"><a href="#_1-3-get-free-page" class="header-anchor">#</a> 1.3 __get_free_page</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define __get_free_page(gfp_mask) \
		__get_free_pages((gfp_mask), 0)

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个很明显调用了<code>__get_free_pages</code>,只是页面个数为1.</p> <h3 id="_1-4-get-zeroed-page"><a href="#_1-4-get-zeroed-page" class="header-anchor">#</a> 1.4 get_zeroed_page</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>unsigned long get_zeroed_page(gfp_t gfp_mask)
{
	return __get_free_pages(gfp_mask | __GFP_ZERO, 0);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个函数调用了上面的<code>__get_free_pages</code>,只是设置了<code>__GFP_ZERO</code>,表示需要将页面进行清0处理。另外页面个数部分为0,表示只分配一个页面。</p> <h3 id="_1-5-get-dma-pages"><a href="#_1-5-get-dma-pages" class="header-anchor">#</a> 1.5 __get_dma_pages</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define __get_dma_pages(gfp_mask, order) \
		__get_free_pages((gfp_mask) | GFP_DMA, (order))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里同样调用了<code>__get_free_pages</code>,只是设置了<code>GFP_DMA</code>,表示从DMA内存分区进行内存分配。</p> <h2 id="_2-alloc-pages"><a href="#_2-alloc-pages" class="header-anchor">#</a> 2. alloc_pages</h2> <p>从上面的接口分析中可以看出所有的接口最终都是调用了<code>alloc_pages</code>,下面我重点分析这个函数。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#ifdef CONFIG_NUMA
extern struct page *alloc_pages_current(gfp_t gfp_mask, unsigned order);

static inline struct page *
alloc_pages(gfp_t gfp_mask, unsigned int order)
{
	return alloc_pages_current(gfp_mask, order);
}
extern struct page *alloc_pages_vma(gfp_t gfp_mask, int order,
			struct vm_area_struct *vma, unsigned long addr,
			int node, bool hugepage);
#define alloc_hugepage_vma(gfp_mask, vma, addr, order) \
	alloc_pages_vma(gfp_mask, order, vma, addr, numa_node_id(), true)
#else
#define alloc_pages(gfp_mask, order) \
		alloc_pages_node(numa_node_id(), gfp_mask, order)
#define alloc_pages_vma(gfp_mask, order, vma, addr, node, false)\
	alloc_pages(gfp_mask, order)
#define alloc_hugepage_vma(gfp_mask, vma, addr, order) \
	alloc_pages(gfp_mask, order)
#endif

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>从宏定义可以看出在<code>NUMA</code>和非<code>NUMA</code>,存在不同，我们这里按非<code>NUMA</code>来分析。也就是如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#define alloc_pages(gfp_mask, order) \
		alloc_pages_node(numa_node_id(), gfp_mask, order)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最终调用的是<code>alloc_pages_node</code>,这里的node是<code>NUMA</code>节点。这里<code>numa_node_id</code>返回的是当前<code>CPU</code>所在的<code>NUMA</code>节点，我们这里是讨论的是非<code>NUMA</code>平台，所以这里的节点值为0。</p> <h3 id="_2-1-alloc-pages-node"><a href="#_2-1-alloc-pages-node" class="header-anchor">#</a> 2.1 alloc_pages_node</h3> <p>从上面的分析最终是调用了<code>alloc_pages_node</code>,代码如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>static inline struct page *alloc_pages_node(int nid, gfp_t gfp_mask,
						unsigned int order)
{
	if (nid == NUMA_NO_NODE)
		nid = numa_mem_id();

	return __alloc_pages_node(nid, gfp_mask, order);
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>代码很简单就是调用<code>__alloc_pages_node</code></p> <h3 id="_2-2-alloc-pages-node"><a href="#_2-2-alloc-pages-node" class="header-anchor">#</a> 2.2 __alloc_pages_node</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>static inline struct page *
__alloc_pages_node(int nid, gfp_t gfp_mask, unsigned int order)
{
	/* 保证nid的合法性 */
	VM_BUG_ON(nid &lt; 0 || nid &gt;= MAX_NUMNODES);
	VM_WARN_ON((gfp_mask &amp; __GFP_THISNODE) &amp;&amp; !node_online(nid));

	return __alloc_pages(gfp_mask, order, nid);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-3-alloc-pages"><a href="#_2-3-alloc-pages" class="header-anchor">#</a> 2.3 __alloc_pages</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct page *
__alloc_pages_nodemask(gfp_t gfp_mask, unsigned int order, int preferred_nid,
							nodemask_t *nodemask);

static inline struct page *
__alloc_pages(gfp_t gfp_mask, unsigned int order, int preferred_nid)
{
	return __alloc_pages_nodemask(gfp_mask, order, preferred_nid, NULL);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面代码很简单，<code>__alloc_pages_nodemask</code>是真正的内存分配函数。</p> <h3 id="_3-alloc-pages-nodemask"><a href="#_3-alloc-pages-nodemask" class="header-anchor">#</a> 3. __alloc_pages_nodemask</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct page *
__alloc_pages_nodemask(gfp_t gfp_mask, unsigned int order, int preferred_nid,
							nodemask_t *nodemask)
{
	struct page *page;
	unsigned int alloc_flags = ALLOC_WMARK_LOW;
	gfp_t alloc_mask; /* The gfp_t that was actually used for allocation */
	struct alloc_context ac = { };

	/*
	 * There are several places where we assume that the order value is sane
	 * so bail out early if the request is out of bound.
	 */
	if (unlikely(order &gt;= MAX_ORDER)) {
		WARN_ON_ONCE(!(gfp_mask &amp; __GFP_NOWARN));
		return NULL;
	}

	/*
	 * gfp_allowed_mask 在系统启动中为GFP_BOOT_MASK
	 * #define GFP_BOOT_MASK (__GFP_BITS_MASK &amp; ~(__GFP_RECLAIM|__GFP_IO|__GFP_FS))
	 *
	 * 后设置为如下
	 * gfp_allowed_mask = __GFP_BITS_MASK; = 0x7FFFFF;
	 *
	 */
	gfp_mask &amp;= gfp_allowed_mask;
	alloc_mask = gfp_mask;
	/*
	 * prepare_alloc_pages 主要是初始化ac，具体见函数实现
	 */
	if (!prepare_alloc_pages(gfp_mask, order, preferred_nid, nodemask, &amp;ac, &amp;alloc_mask, &amp;alloc_flags))
		return NULL;
	/*
	 * 这里主要是要找一个最好的zone用于后面分配内存
	 *
	 * */
	finalise_ac(gfp_mask, &amp;ac);

	/*
	 * Forbid the first pass from falling back to types that fragment
	 * memory until all local zones are considered.
	 */
	alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp_mask);
	/*
	 * 大部分情况会走这里
	 */
	/* First allocation attempt */
	page = get_page_from_freelist(alloc_mask, order, alloc_flags, &amp;ac);
	if (likely(page))
		goto out;

	/*
	 * Apply scoped allocation constraints. This is mainly about GFP_NOFS
	 * resp. GFP_NOIO which has to be inherited for all allocation requests
	 * from a particular context which has been marked by
	 * memalloc_no{fs,io}_{save,restore}.
	 */
	alloc_mask = current_gfp_context(gfp_mask);
	ac.spread_dirty_pages = false;

	/*
	 * Restore the original nodemask if it was potentially replaced with
	 * &amp;cpuset_current_mems_allowed to optimize the fast-path attempt.
	 */
	ac.nodemask = nodemask;
	/*
	 * 系统内存不足，先回收再分配
	 */

	page = __alloc_pages_slowpath(alloc_mask, order, &amp;ac);

out:
	if (memcg_kmem_enabled() &amp;&amp; (gfp_mask &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;
	    unlikely(__memcg_kmem_charge_page(page, gfp_mask, order) != 0)) {
		__free_pages(page, order);
		page = NULL;
	}

	trace_mm_page_alloc(page, order, alloc_mask, ac.migratetype);

	return page;
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h2 id="_4-小结"><a href="#_4-小结" class="header-anchor">#</a> 4. 小结</h2> <p>本文只是梳理了大体的内存页面分配的思路，从上面代码分析中可以看到<code>__alloc_pages_nodemask</code>才是真正的分配函数，无论你调用了那个接口函数，最终都会调到这里。</p> <hr> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>欢迎评论、探讨,如果发现错误请指正。转载请注明出处！ <a href="http://www.tsz.wiki" target="_blank" rel="noopener noreferrer">探索者<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <hr> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新 :</span> <span class="time">7/6/2021, 11:46:51 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/linux/memory/buddy/wartermark/watermark.html" class="prev">
        水位线的计算
      </a></span> <span class="next"><a href="/linux/memory/slub/slub_order/slub_order.html">
        SLUB计算order
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.da3d5808.js" defer></script><script src="/assets/js/2.5ade7cf8.js" defer></script><script src="/assets/js/41.327a65a5.js" defer></script>
  </body>
</html>
