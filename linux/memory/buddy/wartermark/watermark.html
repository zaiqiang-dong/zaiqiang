<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>水位线的计算 | 探索者</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="icon" href="/hero.png">
    <meta name="description" content="-> 在 LINUX ANDROID 中不断探索 <-">
    <link rel="preload" href="/assets/css/0.styles.edfc0aeb.css" as="style"><link rel="preload" href="/assets/js/app.43aa4b63.js" as="script"><link rel="preload" href="/assets/js/2.60076c9c.js" as="script"><link rel="preload" href="/assets/js/10.aad611b4.js" as="script"><link rel="prefetch" href="/assets/js/11.ab1787a8.js"><link rel="prefetch" href="/assets/js/12.0e9267d2.js"><link rel="prefetch" href="/assets/js/13.c835ff05.js"><link rel="prefetch" href="/assets/js/14.2cdf1ff2.js"><link rel="prefetch" href="/assets/js/15.2de60435.js"><link rel="prefetch" href="/assets/js/16.8cd7245e.js"><link rel="prefetch" href="/assets/js/17.cf9695b5.js"><link rel="prefetch" href="/assets/js/18.57344651.js"><link rel="prefetch" href="/assets/js/19.1fb636e3.js"><link rel="prefetch" href="/assets/js/20.b4acf74c.js"><link rel="prefetch" href="/assets/js/21.b897ecde.js"><link rel="prefetch" href="/assets/js/22.281512bb.js"><link rel="prefetch" href="/assets/js/23.9541aaaa.js"><link rel="prefetch" href="/assets/js/24.97b16305.js"><link rel="prefetch" href="/assets/js/25.f2772f39.js"><link rel="prefetch" href="/assets/js/26.1d5cc05a.js"><link rel="prefetch" href="/assets/js/27.b7233167.js"><link rel="prefetch" href="/assets/js/28.904814cc.js"><link rel="prefetch" href="/assets/js/29.e5183204.js"><link rel="prefetch" href="/assets/js/3.4abae474.js"><link rel="prefetch" href="/assets/js/30.a0eeceb2.js"><link rel="prefetch" href="/assets/js/31.e28e302f.js"><link rel="prefetch" href="/assets/js/32.e3d441fd.js"><link rel="prefetch" href="/assets/js/33.0681603c.js"><link rel="prefetch" href="/assets/js/34.cf581731.js"><link rel="prefetch" href="/assets/js/35.a6e0f310.js"><link rel="prefetch" href="/assets/js/4.ecd42b2e.js"><link rel="prefetch" href="/assets/js/5.54babe07.js"><link rel="prefetch" href="/assets/js/6.33dc52fb.js"><link rel="prefetch" href="/assets/js/7.26ff6305.js"><link rel="prefetch" href="/assets/js/8.49ba7707.js"><link rel="prefetch" href="/assets/js/9.2c90890a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.edfc0aeb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">探索者</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/" class="nav-link router-link-active">
  内核
</a></div><div class="nav-item"><a href="/hardware/" class="nav-link">
  硬件
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/coding/" class="nav-link">
  编码
</a></div><div class="nav-item"><a href="/virtualization/" class="nav-link">
  虚拟化
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/" class="nav-link router-link-active">
  内核
</a></div><div class="nav-item"><a href="/hardware/" class="nav-link">
  硬件
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/coding/" class="nav-link">
  编码
</a></div><div class="nav-item"><a href="/virtualization/" class="nav-link">
  虚拟化
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>内存管理</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>common</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>buddy</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/linux/memory/buddy/alloc-flags/alloc-flags.html" class="sidebar-link">页分配掩码</a></li><li><a href="/linux/memory/buddy/wartermark/watermark.html" aria-current="page" class="active sidebar-link">水位线的计算</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/linux/memory/buddy/wartermark/watermark.html#_1-水位线的使用" class="sidebar-link">1. 水位线的使用</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/wartermark/watermark.html#_2-水位线的设置" class="sidebar-link">2. 水位线的设置</a></li><li class="sidebar-sub-header"><a href="/linux/memory/buddy/wartermark/watermark.html#_3-小结" class="sidebar-link">3. 小结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>slxb</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发同步</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进程管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中断系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全机制</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统工具</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="水位线的计算"><a href="#水位线的计算" class="header-anchor">#</a> 水位线的计算</h1> <p>水位线对于伙伴分配的过程比较重要，每次分配时都对水位线进行检测，所以水位线对系统内存管理非常重要，这里将详细介绍小位线在系统中是如何设定的，包括详细其详细的计算过程以及设定的思想。</p> <h2 id="_1-水位线的使用"><a href="#_1-水位线的使用" class="header-anchor">#</a> 1. 水位线的使用</h2> <p>水位线的会被用来指导内存的分配以及回收，具体如下图所示：</p> <p><img src="/assets/img/wartmark-kswapd.74d8ace8.png" alt="wartermark-kswapd"></p> <ul><li>开始的时候内存处于非常充足的位置</li> <li>再后一个节点，内存不断分配，剩余内存降到high以下</li> <li>再后一个节点，内存降到low以下，这时系统感知内存不中会启动kswapd来异步回收内存</li> <li>再后一个节点，内存降到min，这时基本不再分配内存，只有一些特殊的内存分配可以成功，kswapd会同步回收内存</li> <li>随着内存不断回收，剩余内存又会回到high,这里kswapd工作完成进入休眠</li></ul> <h2 id="_2-水位线的设置"><a href="#_2-水位线的设置" class="header-anchor">#</a> 2. 水位线的设置</h2> <p>水位线设置的代码如下：</p> <div class="language-c {.line-numbers} line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">int</span> __meminit <span class="token function">init_per_zone_wmark_min</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> lowmem_kbytes<span class="token punctuation">;</span>
	<span class="token keyword">int</span> new_min_free_kbytes<span class="token punctuation">;</span>

	lowmem_kbytes <span class="token operator">=</span> <span class="token function">nr_free_buffer_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">&gt;&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	new_min_free_kbytes <span class="token operator">=</span> <span class="token function">int_sqrt</span><span class="token punctuation">(</span>lowmem_kbytes <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>new_min_free_kbytes <span class="token operator">&gt;</span> user_min_free_kbytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		min_free_kbytes <span class="token operator">=</span> new_min_free_kbytes<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>min_free_kbytes <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span>
			min_free_kbytes <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>min_free_kbytes <span class="token operator">&gt;</span> <span class="token number">262144</span><span class="token punctuation">)</span>
			min_free_kbytes <span class="token operator">=</span> <span class="token number">262144</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">&quot;min_free_kbytes is not updated to %d because user defined value %d is preferred\n&quot;</span><span class="token punctuation">,</span>
				new_min_free_kbytes<span class="token punctuation">,</span> user_min_free_kbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">setup_per_zone_wmarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">refresh_zone_stat_thresholds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setup_per_zone_lowmem_reserve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_NUMA</span></span>
	<span class="token function">setup_min_unmapped_ratio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setup_min_slab_ratio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token function">khugepaged_min_free_kbytes_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">postcore_initcall</span><span class="token punctuation">(</span>init_per_zone_wmark_min<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>从<code>postcore_initcall</code>可以知道调用流程是<code>start_kernel-&gt;rset_init-&gt;init_per_zone_wmark_min</code>,下面具体分析。</p> <ul><li>代码6～7行：
这里的lowmem_kbytes，不要被变量名迷惑，这个值其实是系统总内存使用KB计量。
看一下<code>nr_free_buffer_pages</code>就明白了</li></ul> <div class="language-c {.line-numbers} line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">nr_free_buffer_pages</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">nr_free_zone_pages</span><span class="token punctuation">(</span><span class="token function">gfp_zone</span><span class="token punctuation">(</span>GFP_USER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">nr_free_zone_pages</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">zoneref</span> <span class="token operator">*</span>z<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">zone</span> <span class="token operator">*</span>zone<span class="token punctuation">;</span>

	<span class="token comment">/* Just pick one node, since fallback list is circular */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">zonelist</span> <span class="token operator">*</span>zonelist <span class="token operator">=</span> <span class="token function">node_zonelist</span><span class="token punctuation">(</span><span class="token function">numa_node_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">for_each_zone_zonelist</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> z<span class="token punctuation">,</span> zonelist<span class="token punctuation">,</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token function">zone_managed_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">long</span> high <span class="token operator">=</span> <span class="token function">high_wmark_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> high<span class="token punctuation">)</span>
			sum <span class="token operator">+=</span> size <span class="token operator">-</span> high<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">high_wmark_pages</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token punctuation">(</span>z<span class="token operator">-&gt;</span>_watermark<span class="token punctuation">[</span>WMARK_HIGH<span class="token punctuation">]</span> <span class="token operator">+</span> z<span class="token operator">-&gt;</span>watermark_boost<span class="token punctuation">)</span></span></span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>在初始化的时候上面的代码，计算出来的high其实是0,这个水位还没有设置，都是默认0.而且会遍历所有的zone,把各个zone管理的页面都加起来，所以<code>lowmem_kbytes</code>其实就是系统总内存量，就是总的页数×4。
第7行<code>new_min_free_kbytes</code>，计算公式如下</p> <p>$$
new_min_free_kbytes = \sqrt{lowmem_kbytes * 16}
$$</p> <p>说明一下这个公式的设计思想，代码作者认为，随着系统内存总量的增加，那个应该保留的最低内存也应该增加，但不应该随着内存增加而线性的增加，原因是网络带宽的增加不是线性的，这个我认为是机器的负载不是线性的增加，更加直观如下图所示：</p> <p><img src="/assets/img/min-kbytes.f649b7d2.png" alt="min-kbytes"></p> <ul><li><p>代码10行：
这里就是保存最小值到<code>min_free_kbytes</code>，下一步的计算会使用到这个值。</p></li> <li><p>代码19行：
<code>setup_per_zone_wmarks()</code>开始计算<code>zone-&gt;_watermark[WMARK_MIN] ,zone-&gt;_watermark[WMARK_LOW], zone-&gt;_watermark[WMARK_HIGH]</code>的值。具体代码如下：</p></li></ul> <div class="language-c {.line-numbers} line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">setup_per_zone_wmarks</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__setup_per_zone_wmarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__setup_per_zone_wmarks</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> pages_min <span class="token operator">=</span> min_free_kbytes <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>PAGE_SHIFT <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> lowmem_pages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">zone</span> <span class="token operator">*</span>zone<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>

	<span class="token comment">/* Calculate total number of !ZONE_HIGHMEM pages */</span>
	<span class="token function">for_each_zone</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_highmem</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">)</span>
			lowmem_pages <span class="token operator">+=</span> <span class="token function">zone_managed_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">for_each_zone</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		u64 tmp<span class="token punctuation">;</span>

		<span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zone<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		tmp <span class="token operator">=</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>pages_min <span class="token operator">*</span> <span class="token function">zone_managed_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">do_div</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> lowmem_pages<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_highmem</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">/*
			 * __GFP_HIGH and PF_MEMALLOC allocations usually don't
			 * need highmem pages, so cap pages_min to a small
			 * value here.
			 *
			 * The WMARK_HIGH-WMARK_LOW and (WMARK_LOW-WMARK_MIN)
			 * deltas control async page reclaim, and so should
			 * not be capped for highmem.
			 */</span>
			<span class="token keyword">unsigned</span> <span class="token keyword">long</span> min_pages<span class="token punctuation">;</span>

			min_pages <span class="token operator">=</span> <span class="token function">zone_managed_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>
			min_pages <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>min_pages<span class="token punctuation">,</span> SWAP_CLUSTER_MAX<span class="token punctuation">,</span> <span class="token number">128UL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			zone<span class="token operator">-&gt;</span>_watermark<span class="token punctuation">[</span>WMARK_MIN<span class="token punctuation">]</span> <span class="token operator">=</span> min_pages<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">/*
			 * If it's a lowmem zone, reserve a number of pages
			 * proportionate to the zone's size.
			 */</span>
			zone<span class="token operator">-&gt;</span>_watermark<span class="token punctuation">[</span>WMARK_MIN<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">/*
		 * Set the kswapd watermarks distance according to the
		 * scale factor in proportion to available memory, but
		 * ensure a minimum size on small systems.
		 */</span>
		tmp <span class="token operator">=</span> <span class="token function">max_t</span><span class="token punctuation">(</span>u64<span class="token punctuation">,</span> tmp <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
			    <span class="token function">mult_frac</span><span class="token punctuation">(</span><span class="token function">zone_managed_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">,</span>
				      watermark_scale_factor<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		zone<span class="token operator">-&gt;</span>watermark_boost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		zone<span class="token operator">-&gt;</span>_watermark<span class="token punctuation">[</span>WMARK_LOW<span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token function">min_wmark_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span> <span class="token operator">+</span> tmp<span class="token punctuation">;</span>
		zone<span class="token operator">-&gt;</span>_watermark<span class="token punctuation">[</span>WMARK_HIGH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">min_wmark_pages</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span> <span class="token operator">+</span> tmp <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>

		<span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zone<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* update totalreserve_pages */</span>
	<span class="token function">calculate_totalreserve_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>代码逻辑其实非常简单，下面说明一下</p> <ul><li><p>代码18～21行：
累加各个zone的页面数到<code>lowmem_pages</code>.</p></li> <li><p>代码23行：
就是对各个zone都计算一下水位线。</p></li> <li><p>代码27～28行：
这两个是整个函数的核心，这里的<code>pages_min</code>就是<code>min_free_kbytes</code>除以4转化为整个系统应该保留的最小页面数。那这里的<code>tmp</code>计算出来就应该是当前循环的zone所应保留的最小页面数，具体公式如下
$$
tmp = \frac{pages_min * zone_managed_pages(zone)}{lowmem_pages}
$$
$$
= \frac{整个系统保留最少页面数 * 当前zone的页面数}{所有zone总的页面数}
$$</p> <p>$$
= 整个系统保留最少页面数 * \frac{当前zone的页面数}{当前zone的页面数}
$$</p></li> <li><p>代码49行：
设置<code>zone-&gt;_watermark[WMARK_MIN]</code>值</p></li> <li><p>代码57～59：	
这里就是从<mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="3.782ex" height="2.862ex" viewBox="0 -919.8 1671.8 1264.8" style="vertical-align:-0.781ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(220, 477.2) scale(0.707)"><g data-mml-node="mi"><path data-c="74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(361, 0)"><path data-c="6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1239, 0)"><path data-c="70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g><g data-mml-node="mn" transform="translate(659.1, -345) scale(0.707)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><rect width="1431.8" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container>和<mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="19.989ex" height="2.773ex" viewBox="0 -864.9 8835.1 1225.5" style="vertical-align:-0.816ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">当</text><text data-variant="normal" transform="translate(600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">前</text></g><g data-mml-node="mi" transform="translate(1477.8, 0)"><path data-c="7A" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path></g><g data-mml-node="mi" transform="translate(1942.8, 0)"><path data-c="6F" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(2427.8, 0)"><path data-c="6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3027.8, 0)"><path data-c="65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mo" transform="translate(3771.6, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">页</text><text data-variant="normal" transform="translate(600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">面</text><text data-variant="normal" transform="translate(1200, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mo" transform="translate(5849.3, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(6627.3, 0)"><g data-mml-node="mn" transform="translate(750.3, 394) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500, 0)"></path></g><g data-mml-node="mn" transform="translate(220, -345) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500, 0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000, 0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500, 0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2000, 0)"></path></g><rect width="1967.8" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container>中取一个最大的，这里我的理解是考虑kswapd运行需要的最小内存，而且我的实验平台，最终都是<mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="10.741ex" height="2.862ex" viewBox="0 -919.8 4747.3 1264.8" style="vertical-align:-0.781ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(361, 0)"><path data-c="6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1239, 0)"><path data-c="70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(2019.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(3075.6, 0)"><g data-mml-node="mrow" transform="translate(220, 477.2) scale(0.707)"><g data-mml-node="mi"><path data-c="74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(361, 0)"><path data-c="6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1239, 0)"><path data-c="70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g><g data-mml-node="mn" transform="translate(659.1, -345) scale(0.707)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><rect width="1431.8" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container>;</p></li> <li><p>代码62~63行：
设置<code>zone-&gt;_watermark[WMARK_LOW]</code>和<code>zone-&gt;_watermark[WMAR]</code></p></li></ul> <h2 id="_3-小结"><a href="#_3-小结" class="header-anchor">#</a> 3. 小结</h2> <p><code>zone-&gt;_watermark[WMARK_MIN]</code>是通过一个平方的公式计算出来的，而<code>zone-&gt;_watermark[WMARK_LOW]`是等于`zone-&gt;_watermark[WMARK_MIN]`的1.25倍，</code>zone-&gt;_watermark[WMARK_HIGH]<code>是</code>zone-&gt;_watermark[WMARK_MIN]`的1.5倍。</p> <hr> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>转载请注明出处！ <a href="http://www.tsz.wiki" target="_blank" rel="noopener noreferrer">探索者<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <hr> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新 :</span> <span class="time">11/25/2020, 9:30:32 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/linux/memory/buddy/alloc-flags/alloc-flags.html" class="prev">
        页分配掩码
      </a></span> <span class="next"><a href="/linux/filesystem/initrd-principles/initrd-principles.html">
        根文件系统原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.43aa4b63.js" defer></script><script src="/assets/js/2.60076c9c.js" defer></script><script src="/assets/js/10.aad611b4.js" defer></script>
  </body>
</html>
